<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HABIGON ADMIN PANEL | שליטה מלאה</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #00f2ea;
    --secondary: #ff0055;
    --admin-color: #ff9800;
    --ban-color: #721c24;
    --bg-dark: #0a0a12;
    --surface: rgba(255, 255, 255, 0.05);
    --surface-border: rgba(255, 255, 255, 0.1);
    --text-main: #ffffff;
    --blur: 15px;
  }

  * { box-sizing: border-box; outline: none; }
  body {
    font-family: 'Heebo', sans-serif;
    background-color: var(--bg-dark);
    background-image: radial-gradient(circle at 10% 20%, rgba(0, 242, 234, 0.1) 0%, transparent 25%);
    color: var(--text-main);
    margin: 0; min-height: 100vh;
    direction: rtl;
  }

  nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 40px; background: rgba(10, 10, 18, 0.8);
    backdrop-filter: blur(10px); border-bottom: 1px solid var(--surface-border);
    position: sticky; top: 0; z-index: 1000;
  }

  .logo { font-size: 24px; font-weight: 900; color: var(--primary); text-shadow: 0 0 10px var(--primary); }

  .nav-btn {
    background: transparent; border: 1px solid var(--primary); color: var(--primary);
    padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: bold;
  }
  .nav-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }

  main {
    max-width: 1200px; margin: 40px auto; width: 90%;
    display: grid; gap: 30px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }

  .card {
    background: var(--surface); backdrop-filter: blur(var(--blur));
    border: 1px solid var(--surface-border); border-radius: 20px; padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.3s;
  }

  .hidden { display: none !important; }

  h2 { margin-top: 0; border-right: 4px solid var(--secondary); padding-right: 15px; font-size: 1.5rem; }

  input {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--surface-border);
    padding: 14px; border-radius: 10px; color: #fff; margin-bottom: 15px; font-size: 16px;
  }

  .action-btn {
    width: 100%; padding: 14px; border-radius: 10px; border: none;
    background: linear-gradient(45deg, var(--secondary), #ff4d88);
    color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s;
  }

  /* Admin Table */
  .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  .admin-table th, .admin-table td { padding: 12px; text-align: right; border-bottom: 1px solid var(--surface-border); }
  .admin-table th { color: var(--admin-color); }
  
  .btn-sm { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin: 2px; font-weight: bold; }
  .btn-ban { background: var(--secondary); color: #fff; }
  .btn-unban { background: #4caf50; color: #fff; }
  .btn-save { background: var(--primary); color: #000; }
  .btn-role { background: var(--admin-color); color: #000; }

  .code-item {
    background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px;
    border-radius: 10px; border-left: 4px solid var(--primary);
    display: flex; justify-content: space-between; align-items: center;
  }

  #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
  .toast { background: #1a1a2e; color: #fff; padding: 15px 25px; border-radius: 10px; margin-top: 10px; border-right: 4px solid var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }

  .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; margin: 0 auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading .spinner { display: block; }
  .loading span { display: none; }
</style>
</head>
<body>

<nav>
  <div class="logo"><i class="fas fa-crown"></i> קניית כרטיסים IL</div>
  <div id="user-info" class="hidden" style="display: flex; align-items: center; gap: 20px;">
    <span id="user-display" style="font-weight: bold;"></span>
    <button id="logoutBtn" class="nav-btn">התנתק</button>
  </div>
</nav>

<main>
  <section id="auth-section" class="card">
    <h2>כניסה למערכת</h2>
    <input type="email" id="email" placeholder="אימייל">
    <input type="password" id="password" placeholder="סיסמה">
    <button id="loginBtn" class="action-btn"><span>התחבר</span><div class="spinner"></div></button>
    <button id="signupBtn" class="action-btn" style="background: transparent; border: 1px solid var(--surface-border); margin-top: 10px;"><span>הרשמה</span><div class="spinner"></div></button>
  </section>

  <section id="store-section" class="card hidden">
    <h2>חנות</h2>
    <div style="text-align:center; padding: 20px; border: 1px dashed var(--primary); border-radius: 15px;">
        <i class="fas fa-ticket-alt" style="font-size: 30px; color: var(--primary);"></i>
        <h3>כרטיס VRFS</h3>
        <p>יתרה נוכחית: <span id="user-balance" style="color:var(--primary); font-weight:bold;">0</span> ₪</p>
        <button id="buyBtn" class="action-btn">רכוש ב-50 ₪</button>
    </div>
  </section>

  <section id="dashboard-section" class="card hidden">
    <h2>הכרטיסים שלי</h2>
    <ul id="codes"></ul>
  </section>

  <section id="admin-section" class="card hidden" style="grid-column: 1 / -1; border-color: var(--admin-color);">
    <h2 style="color: var(--admin-color); border-color: var(--admin-color);">ניהול שחקנים (ADMIN)</h2>
    <div style="overflow-x: auto;">
      <table class="admin-table">
        <thead>
          <tr>
            <th>משתמש</th>
            <th>תפקיד</th>
            <th>יתרה (₪)</th>
            <th>מצב</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody id="admin-users-list"></tbody>
      </table>
    </div>
  </section>
</main>

<div id="toast-container"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, serverTimestamp, query, where, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDo06TWeTpDCiHjE6gu5yCx9MalJ3Pfpz0",
    authDomain: "habigon-b3544.firebaseapp.com",
    projectId: "habigon-b3544",
    storageBucket: "habigon-b3544.firebasestorage.app",
    messagingSenderId: "1006576861174",
    appId: "1:1006576861174:web:41d2fd9a7a72651b3cd1d7",
    measurementId: "G-H6WHS5JD9K"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function showToast(m) {
    const t = document.createElement('div'); t.className='toast'; t.innerText=m;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }

  // --- פונקציות מנהל הגלובליות ---
  window.adminUpdateBalance = async (uid) => {
    const bal = document.getElementById(`bal-${uid}`).value;
    await updateDoc(doc(db, "users", uid), { balance: Number(bal) });
    showToast("יתרה עודכנה");
  };

  window.adminToggleBan = async (uid, isCurrentlyBanned) => {
    await updateDoc(doc(db, "users", uid), { isBanned: !isCurrentlyBanned });
    showToast(!isCurrentlyBanned ? "משתמש נחסם" : "חסימה הוסרה");
    loadAdminData();
  };

  window.adminSetRole = async (uid, currentRole) => {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    await updateDoc(doc(db, "users", uid), { role: newRole });
    loadAdminData();
  };

  // --- הרשמה וכניסה ---
  document.getElementById('signupBtn').onclick = async () => {
    const e = document.getElementById('email').value, p = document.getElementById('password').value;
    try {
      const res = await createUserWithEmailAndPassword(auth, e, p);
      await setDoc(doc(db, "users", res.user.uid), { email: e, balance: 0, role: "user", isBanned: false, createdAt: serverTimestamp() });
      showToast("נרשמת בהצלחה!");
    } catch (err) { showToast(err.message); }
  };

  document.getElementById('loginBtn').onclick = async () => {
    const e = document.getElementById('email').value, p = document.getElementById('password').value;
    try {
      await signInWithEmailAndPassword(auth, e, p);
    } catch (err) { showToast("פרטים שגויים"); }
  };

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // --- קנייה ---
  document.getElementById('buyBtn').onclick = async () => {
    const u = auth.currentUser;
    const userDoc = await getDoc(doc(db, "users", u.uid));
    const data = userDoc.data();
    if(data.balance < 50) return showToast("אין לך מספיק כסף!");
    
    await updateDoc(doc(db, "users", u.uid), { balance: data.balance - 50 });
    const code = "VRFS-" + Math.random().toString(36).substr(2,9).toUpperCase();
    await addDoc(collection(db, "userCodes"), { uid: u.uid, code: code, timestamp: serverTimestamp() });
    showToast("נרכש בהצלחה!");
    location.reload();
  };

  // --- טעינת נתונים ---
  async function loadAdminData() {
    const list = document.getElementById('admin-users-list');
    const snap = await getDocs(collection(db, "users"));
    list.innerHTML = "";
    snap.forEach(d => {
      const u = d.data();
      list.innerHTML += `
        <tr>
          <td>${u.email}</td>
          <td><button class="btn-sm btn-role" onclick="adminSetRole('${d.id}', '${u.role}')">${u.role}</button></td>
          <td><input type="number" id="bal-${d.id}" value="${u.balance}" style="width:60px"> <button class="btn-sm btn-save" onclick="adminUpdateBalance('${d.id}')">v</button></td>
          <td style="color:${u.isBanned ? 'red' : 'green'}">${u.isBanned ? 'חסום' : 'פעיל'}</td>
          <td>
            <button class="btn-sm ${u.isBanned ? 'btn-unban' : 'btn-ban'}" onclick="adminToggleBan('${d.id}', ${u.isBanned})">
              ${u.isBanned ? 'שחרר חסימה' : 'תן באן'}
            </button>
          </td>
        </tr>`;
    });
  }

  async function loadUserCodes(uid) {
    const q = query(collection(db, "userCodes"), where("uid", "==", uid));
    const snap = await getDocs(q);
    const list = document.getElementById('codes'); list.innerHTML = "";
    snap.forEach(d => { list.innerHTML += `<li class="code-item"><span>${d.data().code}</span></li>`; });
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const userData = userDoc.data();

      if(userData.isBanned) {
        showToast("החשבון שלך חסום!");
        signOut(auth);
        return;
      }

      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('store-section').classList.remove('hidden');
      document.getElementById('dashboard-section').classList.remove('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      document.getElementById('user-display').innerText = user.email;
      document.getElementById('user-balance').innerText = userData.balance || 0;
      
      loadUserCodes(user.uid);
      if(userData.role === 'admin') {
        document.getElementById('admin-section').classList.remove('hidden');
        loadAdminData();
      }
    } else {
      location.reload; // פשטות לרענון מצב
    }
  });
</script>
</body>
</html>
