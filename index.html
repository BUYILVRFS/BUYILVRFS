<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×§× ×™×™×ª ×›×¨×˜×™×¡×™×/title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #00f2ea; --secondary: #ff0055; --admin-color: #ff9800; --discord-color: #5865F2;
    --bg-dark: #0a0a12; --surface: rgba(255, 255, 255, 0.05); --text-main: #ffffff;
  }
  * { box-sizing: border-box; outline: none; }
  body { font-family: 'Heebo', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; direction: rtl; }
  
  nav { display: flex; justify-content: space-between; padding: 15px 40px; background: rgba(10, 10, 18, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
  .logo { font-size: 24px; font-weight: 900; color: var(--primary); }

  main { max-width: 1100px; margin: 40px auto; width: 90%; display: grid; gap: 20px; }
  .card { background: var(--surface); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
  .hidden { display: none !important; }

  input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; margin-bottom: 10px; }
  .action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(45deg, var(--secondary), #ff4d88); color: white; font-weight: bold; cursor: pointer; }
  
  .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
  .admin-table th, .admin-table td { padding: 10px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1); }
  
  .game-box { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 20px; border-radius: 15px; text-align: center; border: 2px solid var(--primary); }
  .toast { position: fixed; bottom: 20px; left: 20px; background: #1a1a2e; color: #fff; padding: 15px; border-radius: 10px; border-right: 4px solid var(--primary); z-index: 2000; }
</style>
</head>
<body>

<nav>
  <div class="logo">×§× ×™×™×ª ×›×¨×˜×™×¡×™× ×œ××©×—×§</div>
  <div id="user-info" class="hidden" style="display:flex; align-items:center; gap:15px;">
    <div style="text-align: left;"><span id="user-display" style="font-weight:900"></span><br><small id="user-balance-nav" style="color:var(--primary)">0 â‚ª</small></div>
    <button id="logoutBtn" style="background:none; border:1px solid var(--primary); color:var(--primary); cursor:pointer; border-radius:20px; padding:5px 15px;">×”×ª× ×ª×§</button>
  </div>
</nav>

<main>
  <section id="auth-section" class="card">
    <h2>×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
    <div id="signup-fields" class="hidden">
        <input type="text" id="reg-name" placeholder="×©× ××œ×">
    </div>
    <input type="email" id="email" placeholder="××™××™×™×œ">
    <input type="password" id="password" placeholder="×¡×™×¡××”">
    <button id="loginBtn" class="action-btn">×”×ª×—×‘×¨</button>
    <button id="toggleRegBtn" style="background:none; border:none; color:var(--primary); cursor:pointer; margin-top:10px;">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ</button>
    <button id="signupBtn" class="action-btn hidden" style="background:var(--primary); color:#000;">×¦×•×¨ ×—×©×‘×•×Ÿ</button>
  </section>

  <section id="store-section" class="card hidden">
    <h2>×”××©×—×§ ×”×§×¨×•×‘</h2>
    <div id="no-game" style="text-align:center; opacity:0.6;">××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢. ×”××ª×Ÿ ×œ×× ×”×œ.</div>
    <div id="active-game-box" class="game-box hidden">
        <h1 id="display-teams" style="margin:10px 0; color:var(--primary);">×§×‘×•×¦×” ×' VS ×§×‘×•×¦×” ×‘'</h1>
        <p>××—×™×¨ ×›× ×™×¡×”: <span id="display-price" style="font-weight:bold;">0</span> â‚ª</p>
        <button id="buyGameBtn" class="action-btn">×¨×›×•×© ×›×¨×˜×™×¡ ×œ××©×—×§</button>
    </div>
    
    <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
        <h3 style="color:var(--discord-color)">×× ×•×™ ×©×™×“×•×¨×™× (100 â‚ª)</h3>
        <button onclick="buySub()" class="action-btn" style="background:var(--discord-color);">×§× ×” ×× ×•×™ ×œ×©×™×“×•×¨×™×</button>
    </div>
  </section>

  <section id="dashboard-section" class="card hidden">
    <h2>×”×›×¨×˜×™×¡×™× ×©×œ×™</h2>
    <ul id="user-codes-list"></ul>
  </section>

  <section id="admin-section" class="card hidden" style="border-color:var(--admin-color); grid-column: 1 / -1;">
    <h2 style="color:var(--admin-color);">×¤×× ×œ ×× ×”×œ - × ×™×”×•×œ ××©×—×§×™× ×•×©×—×§× ×™×</h2>
    
    <div style="background:rgba(255,152,0,0.1); padding:15px; border-radius:10px; margin-bottom:20px;">
        <h4>×”×’×“×¨×ª ××©×—×§ ×—×“×©</h4>
        <input type="text" id="admin-teams" placeholder="××™ × ×’×“ ××™ (×œ×“×•×’××”: ×‘×¨×–×™×œ × ×’×“ ××¨×’× ×˜×™× ×”)">
        <input type="number" id="admin-price" placeholder="××—×™×¨ ×›×¨×˜×™×¡ (â‚ª)">
        <div style="display:flex; gap:10px;">
            <button id="admin-open-game" class="action-btn" style="background:#4caf50;">×¤×ª×— ××©×—×§ ×œ××›×™×¨×”</button>
            <button id="admin-close-game" class="action-btn" style="background:var(--secondary);">×¡×’×•×¨ ××©×—×§</button>
        </div>
    </div>

    <table class="admin-table">
        <thead><tr><th>×©×</th><th>××™××™×™×œ</th><th>×™×ª×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="admin-users-list"></tbody>
    </table>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot, addDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDo06TWeTpDCiHjE6gu5yCx9MalJ3Pfpz0",
    authDomain: "habigon-b3544.firebaseapp.com",
    projectId: "habigon-b3544",
    storageBucket: "habigon-b3544.firebasestorage.app",
    messagingSenderId: "1006576861174",
    appId: "1:1006576861174:web:41d2fd9a7a72651b3cd1d7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function showToast(m) {
    const t = document.createElement('div'); t.className='toast'; t.innerText=m;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 3000);
  }

  // --- × ×™×”×•×œ ××©×—×§ ---
  onSnapshot(doc(db, "settings", "gameConfig"), (s) => {
    if(s.exists()){
        const d = s.data();
        if(d.isOpen) {
            document.getElementById('no-game').classList.add('hidden');
            document.getElementById('active-game-box').classList.remove('hidden');
            document.getElementById('display-teams').innerText = d.teams;
            document.getElementById('display-price').innerText = d.price;
            window.currentGamePrice = d.price;
            window.currentGameTeams = d.teams;
        } else {
            document.getElementById('no-game').classList.remove('hidden');
            document.getElementById('active-game-box').classList.add('hidden');
        }
    }
  });

  document.getElementById('admin-open-game').onclick = async () => {
    const teams = document.getElementById('admin-teams').value;
    const price = document.getElementById('admin-price').value;
    if(!teams || !price) return showToast("××œ× ××ª ×¤×¨×˜×™ ×”××©×—×§");
    await setDoc(doc(db, "settings", "gameConfig"), { isOpen: true, teams, price: Number(price) });
    showToast("×”××©×—×§ × ×¤×ª×— ×œ××›×™×¨×”!");
  };

  document.getElementById('admin-close-game').onclick = async () => {
    await updateDoc(doc(db, "settings", "gameConfig"), { isOpen: false });
    showToast("×”××©×—×§ × ×¡×’×¨");
  };

  // --- ×¨×›×™×©×•×ª ---
  document.getElementById('buyGameBtn').onclick = async () => {
    const u = auth.currentUser;
    const userSnap = await getDoc(doc(db, "users", u.uid));
    const balance = userSnap.data().balance;
    if(balance < window.currentGamePrice) return showToast("××™×Ÿ ×œ×š ××¡×¤×™×§ ×›×¡×£!");

    await updateDoc(doc(db, "users", u.uid), { balance: balance - window.currentGamePrice });
    const code = "GAME-" + Math.random().toString(36).substr(2,6).toUpperCase();
    await addDoc(collection(db, "userCodes"), { uid: u.uid, code: code, teams: window.currentGameTeams });
    showToast("×›×¨×˜×™×¡ × ×¨×›×©!");
  };

  window.buySub = async () => {
    const u = auth.currentUser;
    const userSnap = await getDoc(doc(db, "users", u.uid));
    if(userSnap.data().balance < 100) return showToast("××™×Ÿ ××¡×¤×™×§ ×›×¡×£!");
    await updateDoc(doc(db, "users", u.uid), { balance: userSnap.data().balance - 100, hasDiscordSub: true });
    showToast("×× ×•×™ ×©×™×“×•×¨×™× ×”×•×¤×¢×œ!");
  };

  // --- ××“××™×Ÿ: ×”×•×¡×¤×ª ×›×¡×£ ×—×•×¤×©×™×ª ---
  window.addCustomMoney = async (uid) => {
    const val = document.getElementById(`input-money-${uid}`).value;
    if(!val) return;
    const ref = doc(db, "users", uid);
    const s = await getDoc(ref);
    await updateDoc(ref, { balance: (s.data().balance || 0) + Number(val) });
    showToast(`×¢×•×“×›×Ÿ ×¡×›×•× ×©×œ ${val} â‚ª`);
    loadAdminTable();
  };

  // --- Auth ---
  document.getElementById('toggleRegBtn').onclick = () => {
    document.getElementById('signup-fields').classList.toggle('hidden');
    document.getElementById('signupBtn').classList.toggle('hidden');
    document.getElementById('loginBtn').classList.toggle('hidden');
    document.getElementById('toggleRegBtn').innerText = document.getElementById('signupBtn').classList.contains('hidden') ? "××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ" : "×›×‘×¨ ×¨×©×•×? ×”×ª×—×‘×¨";
  };

  document.getElementById('signupBtn').onclick = async () => {
    const name = document.getElementById('reg-name').value;
    const e = document.getElementById('email').value, p = document.getElementById('password').value;
    if(!name) return showToast("×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ××œ×");
    const res = await createUserWithEmailAndPassword(auth, e, p);
    await setDoc(doc(db, "users", res.user.uid), { fullName: name, email: e, balance: 0, role: 'user' });
  };

  document.getElementById('loginBtn').onclick = () => signInWithEmailAndPassword(auth, email.value, password.value);
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if(user) {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('store-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        
        onSnapshot(doc(db, "users", user.uid), (d) => {
            const data = d.data();
            document.getElementById('user-display').innerText = data.fullName || data.email;
            document.getElementById('user-balance-nav').innerText = data.balance + " â‚ª";
            if(data.role === 'admin') {
                document.getElementById('admin-section').classList.remove('hidden');
                loadAdminTable();
            }
        });

        onSnapshot(query(collection(db, "userCodes"), where("uid", "==", user.uid)), (snap) => {
            const l = document.getElementById('user-codes-list'); l.innerHTML = "";
            snap.forEach(doc => l.innerHTML += `<li class="card" style="margin-bottom:10px; padding:10px;">ğŸ« ${doc.data().teams} | ×§×•×“: ${doc.data().code}</li>`);
        });
    }
  });

  async function loadAdminTable() {
    const snap = await getDocs(collection(db, "users"));
    const list = document.getElementById('admin-users-list'); list.innerHTML = "";
    snap.forEach(d => {
        const u = d.data();
        list.innerHTML += `<tr>
            <td>${u.fullName || '×œ×œ× ×©×'}</td>
            <td>${u.email}</td>
            <td>${u.balance} â‚ª</td>
            <td>
                <input type="number" id="input-money-${d.id}" placeholder="×¡×›×•×" style="width:70px; margin:0; padding:5px;">
                <button onclick="addCustomMoney('${d.id}')" style="padding:5px 10px; cursor:pointer;">×‘×¦×¢</button>
            </td>
        </tr>`;
    });
  }
</script>
</body>
</html>
