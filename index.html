<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××©×—×§×™× ×•×©×™×“×•×¨×™×</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #00f2ea; --secondary: #ff0055; --admin-color: #ff9800; --discord-color: #5865F2;
    --bg-dark: #0a0a12; --surface: rgba(255, 255, 255, 0.05); --text-main: #ffffff;
  }
  * { box-sizing: border-box; outline: none; }
  body { font-family: 'Heebo', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; direction: rtl; }
    
  nav { display: flex; justify-content: space-between; padding: 15px 40px; background: rgba(10, 10, 18, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
  .logo { font-size: 24px; font-weight: 900; color: var(--primary); }

  main { max-width: 1100px; margin: 40px auto; width: 90%; display: grid; gap: 20px; }
  .card { background: var(--surface); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
  .hidden { display: none !important; }

  input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; margin-bottom: 10px; }
  input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
  
  .action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(45deg, var(--secondary), #ff4d88); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
  .action-btn:hover { opacity: 0.8; transform: translateY(-2px); }
  .action-btn:disabled { background: #555; cursor: not-allowed; opacity: 0.5; transform: none; }
    
  .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
  .admin-table th, .admin-table td { padding: 10px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
  .game-box { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 20px; border-radius: 15px; text-align: center; border: 2px solid var(--primary); }
  .discord-box { background: rgba(88, 101, 242, 0.15); border: 2px solid var(--discord-color); padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; animation: fadeIn 0.5s ease; }
    
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
  .toast { position: fixed; bottom: 20px; left: 20px; background: #1a1a2e; color: #fff; padding: 15px; border-radius: 10px; border-right: 4px solid var(--primary); z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<nav>
  <div class="logo">HABIGON</div>
  <div id="user-info" class="hidden" style="display:flex; align-items:center; gap:15px;">
    <div style="text-align: left;"><span id="user-display" style="font-weight:900"></span><br><small id="user-balance-nav" style="color:var(--primary)">0 â‚ª</small></div>
    <button id="logoutBtn" style="background:none; border:1px solid var(--primary); color:var(--primary); cursor:pointer; border-radius:20px; padding:5px 15px;">×”×ª× ×ª×§</button>
  </div>
</nav>

<main>
  <section id="auth-section" class="card">
    <h2 id="auth-title">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
      
    <div id="signup-fields" class="hidden">
        <input type="text" id="reg-name" placeholder="×©× ××œ× (×œ×“×•×’××”: ×™×•×¡×™ ×›×”×Ÿ)">
    </div>
      
    <input type="email" id="email" placeholder="××™××™×™×œ">
    <input type="password" id="password" placeholder="×¡×™×¡××” (××™× ×™××•× 6 ×ª×•×•×™×)">
      
    <button id="loginBtn" class="action-btn">×”×ª×—×‘×¨</button>
    <button id="signupBtn" class="action-btn hidden" style="background:var(--primary); color:#000;">×¦×•×¨ ×—×©×‘×•×Ÿ ×—×“×©</button>
      
    <button id="toggleRegBtn" style="background:none; border:none; color:var(--primary); cursor:pointer; margin-top:15px; width:100%;">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ</button>
  </section>

  <section id="store-section" class="card hidden">
    <h2>×”××©×—×§ ×”×§×¨×•×‘</h2>
    <div id="no-game" style="text-align:center; opacity:0.6;">××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢. ×”××ª×Ÿ ×œ×× ×”×œ.</div>
    <div id="active-game-box" class="game-box hidden">
        <h1 id="display-teams" style="margin:10px 0; color:var(--primary);">×§×‘×•×¦×” ×' VS ×§×‘×•×¦×” ×‘'</h1>
        <p style="font-size: 1.1rem;">â° ×©×¢×ª ×”××©×—×§: <span id="display-time" style="font-weight:bold; color:var(--primary);">--:--</span></p>
        
        <p style="font-size: 0.9rem; color: #aaa;">×›×¨×˜×™×¡×™× ×©× ×•×ª×¨×•: <span id="display-stock" style="color:#fff; font-weight:bold;">--</span></p>

        <p>××—×™×¨ ×›× ×™×¡×”: <span id="display-price" style="font-weight:bold;">0</span> â‚ª</p>
        <button id="buyGameBtn" class="action-btn">×¨×›×•×© ×›×¨×˜×™×¡ ×œ××©×—×§</button>
    </div>
      
    <div id="discord-subscription-area" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
        <h3 style="color:var(--discord-color)"><i class="fab fa-discord"></i> ×× ×•×™ ×œ×©×™×“×•×¨×™× ×©×œ ×©×¨×§</h3>
        <div id="discord-status-not-member">
            <button id="buyDiscordBtn" class="action-btn" style="background:var(--discord-color);">×¨×›×•×© ×× ×•×™ (500,000â‚ª)</button>
        </div>
        <div id="discord-status-member" class="discord-box hidden">
            <h4 style="color:var(--discord-color); margin:0 0 10px 0;">×”×× ×•×™ ×©×œ×š ×¤×¢×™×œ! âœ…</h4>
            <a href="https://discord.gg/5TG9shfXn9" target="_blank" class="action-btn" style="display:block; text-decoration:none; background:#5865F2; text-align:center; margin-top:10px;">
                <i class="fab fa-discord"></i> ×›× ×™×¡×” ×œ×©×¨×ª ×”×“×™×¡×§×•×¨×“
            </a>
        </div>
    </div>
  </section>

  <section id="dashboard-section" class="card hidden">
    <h2>×”×›×¨×˜×™×¡×™× ×©×œ×™</h2>
    <ul id="user-codes-list" style="list-style: none; padding:0;"></ul>
  </section>

  <section id="admin-section" class="card hidden" style="border-color:var(--admin-color); grid-column: 1 / -1;">
    <h2 style="color:var(--admin-color);">×¤×× ×œ ×× ×”×œ</h2>
    <div style="background:rgba(255,152,0,0.1); padding:15px; border-radius:10px; margin-bottom:20px;">
        <h4>×”×’×“×¨×ª ××©×—×§ ×—×“×©</h4>
        <input type="text" id="admin-teams" placeholder="×©× ×”××©×—×§ (××™ × ×’×“ ××™)">
        <input type="number" id="admin-price" placeholder="××—×™×¨ ×›×¨×˜×™×¡ (â‚ª)">
        
        <input type="number" id="admin-max-tickets" placeholder="×›××•×ª ×›×¨×˜×™×¡×™× ×œ××›×™×¨×” (×œ××©×œ: 100)">

        <label style="font-size:0.8rem; color:gray;">×©×¢×ª ×”××©×—×§:</label>
        <input type="time" id="admin-time" style="margin-top:5px;">
        
        <input type="text" id="admin-custom-code" placeholder="×§×•×“ ×”××©×—×§ (×œ×“×•×’××”: SHREK2024)">
        <div style="display:flex; gap:10px;">
            <button id="admin-open-game" class="action-btn" style="background:#4caf50;">×¤×ª×— ××©×—×§ ×œ××›×™×¨×”</button>
            <button id="admin-close-game" class="action-btn" style="background:var(--secondary);">×¡×’×•×¨ ××›×™×¨×”</button>
        </div>
    </div>
    <table class="admin-table">
        <thead><tr><th>×©×</th><th>××™××™×™×œ</th><th>×™×ª×¨×”</th><th>×× ×•×™</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
        <tbody id="admin-users-list"></tbody>
    </table>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot, addDoc, query, where, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDo06TWeTpDCiHjE6gu5yCx9MalJ3Pfpz0",
    authDomain: "habigon-b3544.firebaseapp.com",
    projectId: "habigon-b3544",
    storageBucket: "habigon-b3544.firebasestorage.app",
    messagingSenderId: "1006576861174",
    appId: "1:1006576861174:web:41d2fd9a7a72651b3cd1d7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function showToast(m) {
    const t = document.createElement('div'); t.className='toast'; t.innerText=m;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 4000);
  }

  // --- ×œ×•×’×™×§×ª ×”×—×œ×¤×” ×‘×™×Ÿ ×”×¨×©××” ×œ×”×ª×—×‘×¨×•×ª ---
  let isSignupMode = false;
  const toggleBtn = document.getElementById('toggleRegBtn');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const signupFields = document.getElementById('signup-fields');
  const authTitle = document.getElementById('auth-title');

  toggleBtn.onclick = () => {
      isSignupMode = !isSignupMode;
      if (isSignupMode) {
          signupFields.classList.remove('hidden');
          loginBtn.classList.add('hidden');
          signupBtn.classList.remove('hidden');
          authTitle.innerText = "×”×¨×©××” ×œ××¢×¨×›×ª";
          toggleBtn.innerText = "×™×© ×œ×š ×›×‘×¨ ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨ ×›××Ÿ";
      } else {
          signupFields.classList.add('hidden');
          loginBtn.classList.remove('hidden');
          signupBtn.classList.add('hidden');
          authTitle.innerText = "×›× ×™×¡×” ×œ××¢×¨×›×ª";
          toggleBtn.innerText = "××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©× ×›××Ÿ";
      }
  };

  // --- ×”×ª×—×‘×¨×•×ª ×•×”×¨×©××” ---
  signupBtn.onclick = async () => {
    const name = document.getElementById('reg-name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (!name || !email || !password) return showToast("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª");

    try {
        const res = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", res.user.uid), { 
            fullName: name, 
            email: email, 
            balance: 2000000, 
            role: 'user', 
            hasDiscordSub: false 
        });
        showToast("× ×¨×©××ª ×‘×”×¦×œ×—×”! ×§×™×‘×œ×ª 2 ××™×œ×™×•×Ÿ â‚ª ××ª× ×”!");
    } catch (error) {
        let msg = "×©×’×™××” ×‘×”×¨×©××”";
        if(error.code === 'auth/email-already-in-use') msg = "×”××™×™×œ ×”×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª";
        if(error.code === 'auth/weak-password') msg = "×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×";
        showToast(msg);
        console.error(error);
    }
  };

  loginBtn.onclick = async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
      
    if (!email || !password) return showToast("×× × ××œ× ××™××™×™×œ ×•×¡×™×¡××”");

    try {
        await signInWithEmailAndPassword(auth, email, password);
        showToast("×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!");
    } catch (error) {
        showToast("×©×’×™××”: ×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");
        console.error(error);
    }
  };
    
  document.getElementById('logoutBtn').onclick = () => {
      signOut(auth).then(() => {
          window.location.reload();
      });
  };

  // --- ×œ×•×’×™×§×ª ××©×—×§ (×¨×›×™×©×”) ---
  document.getElementById('buyGameBtn').onclick = async () => {
    const u = auth.currentUser;
    if(!u) return;

    // 1. ×§×‘×œ×ª × ×ª×•× ×™× ×¢×“×›× ×™×™× ×¢×œ ×”××©×—×§ (×›×“×™ ×œ×•×•×“× ××œ××™)
    const gameConfigRef = doc(db, "settings", "gameConfig");
    const gameSnap = await getDoc(gameConfigRef);
    if (!gameSnap.exists()) return;
    
    const gameData = gameSnap.data();

    // ×‘×“×™×§×ª ××œ××™
    if (gameData.soldTickets >= gameData.maxTickets) {
        return showToast("×©×’×™××”: ××–×œ ×”××œ××™ ×œ××©×—×§ ×–×”!");
    }

    // 2. ×‘×“×™×§×” ×× ×”××©×ª××© ×›×‘×¨ ×§× ×” ×›×¨×˜×™×¡ ×œ××©×—×§ ×”×–×”
    const q = query(
        collection(db, "userCodes"), 
        where("uid", "==", u.uid),
        where("teams", "==", gameData.teams) // ×‘×•×“×§×™× ×œ×¤×™ ×©× ×”××©×—×§
    );
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
        return showToast("×©×’×™××”: × ×™×ª×Ÿ ×œ×¨×›×•×© ×¨×§ ×›×¨×˜×™×¡ ××—×“ ×œ××©×—×§!");
    }

    // 3. ×‘×™×¦×•×¢ ×”×¨×›×™×©×”
    const userRef = doc(db, "users", u.uid);
    const userSnap = await getDoc(userRef);
    const balance = userSnap.data().balance;
      
    if(balance < gameData.price) return showToast("××™×Ÿ ×œ×š ××¡×¤×™×§ ×›×¡×£ ×œ×›×¨×˜×™×¡!");

    const finalCode = gameData.customCode || "GAME-" + Math.random().toString(36).substr(2,6).toUpperCase();

    // ×¢×“×›×•×Ÿ ×™×ª×¨×ª ×”××©×ª××©
    await updateDoc(userRef, { balance: balance - gameData.price });
    
    // ×™×¦×™×¨×ª ×”×›×¨×˜×™×¡
    await addDoc(collection(db, "userCodes"), { 
        uid: u.uid, 
        code: finalCode, 
        teams: gameData.teams,
        time: gameData.time,
        purchaseDate: new Date().toLocaleString()
    });

    // ×¢×“×›×•×Ÿ ×›××•×ª ×”×›×¨×˜×™×¡×™× ×©× ××›×¨×• (×”×•×¨×“×” ××”××œ××™ ×‘×¤×•×¢×œ)
    await updateDoc(gameConfigRef, {
        soldTickets: increment(1)
    });

    showToast("×”×›×¨×˜×™×¡ × ×¨×›×© ×‘×”×¦×œ×—×”!");
  };

  // --- ×”×’×“×¨×•×ª ××“××™×Ÿ ---
  document.getElementById('admin-open-game').onclick = async () => {
    const teams = document.getElementById('admin-teams').value;
    const price = document.getElementById('admin-price').value;
    const maxTickets = document.getElementById('admin-max-tickets').value; // ×›××•×ª ××§×¡×™××œ×™×ª
    const time = document.getElementById('admin-time').value;
    const customCode = document.getElementById('admin-custom-code').value;

    if(!teams || !price || !time || !maxTickets) return showToast("× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™× (×›×•×œ×œ ×›××•×ª ×›×¨×˜×™×¡×™×)");

    await setDoc(doc(db, "settings", "gameConfig"), { 
        isOpen: true, 
        teams: teams, 
        price: Number(price),
        maxTickets: Number(maxTickets),
        soldTickets: 0, // ××™×¤×•×¡ ××•× ×” ×”××›×™×¨×•×ª
        time: time,
        customCode: customCode || null
    });
    showToast("×”××©×—×§ ×¢×•×“×›×Ÿ ×•× ×¤×ª×— ×œ××›×™×¨×”!");
  };

  onSnapshot(doc(db, "settings", "gameConfig"), (s) => {
    if(s.exists()){
        const d = s.data();
        if(d.isOpen) {
            document.getElementById('no-game').classList.add('hidden');
            document.getElementById('active-game-box').classList.remove('hidden');
            document.getElementById('display-teams').innerText = d.teams;
            document.getElementById('display-price').innerText = d.price;
            document.getElementById('display-time').innerText = d.time;
            
            // ×—×™×©×•×‘ ×•×”×¦×’×ª ××œ××™
            const left = d.maxTickets - (d.soldTickets || 0);
            const stockDisplay = document.getElementById('display-stock');
            const buyBtn = document.getElementById('buyGameBtn');

            if (left <= 0) {
                stockDisplay.innerText = "××–×œ ×”××œ××™!";
                stockDisplay.style.color = "red";
                buyBtn.innerText = "××–×œ ×”××œ××™ âŒ";
                buyBtn.disabled = true;
            } else {
                stockDisplay.innerText = left;
                stockDisplay.style.color = "#00f2ea";
                buyBtn.innerText = "×¨×›×•×© ×›×¨×˜×™×¡ ×œ××©×—×§";
                buyBtn.disabled = false;
            }
            
            window.currentGamePrice = d.price;
        } else {
            document.getElementById('no-game').classList.remove('hidden');
            document.getElementById('active-game-box').classList.add('hidden');
        }
    }
  });

  document.getElementById('buyDiscordBtn').onclick = async () => {
    const u = auth.currentUser;
    const userRef = doc(db, "users", u.uid);
    const userSnap = await getDoc(userRef);
    
    const subscriptionPrice = 500000;

    if(userSnap.data().balance < subscriptionPrice) return showToast("××™×Ÿ ××¡×¤×™×§ ×›×¡×£! ×¦×¨×™×š ×—×¦×™ ××™×œ×™×•×Ÿ");
    
    await updateDoc(userRef, { 
        balance: userSnap.data().balance - subscriptionPrice, 
        hasDiscordSub: true, 
        lastBillingDate: Date.now() 
    });
    showToast("×× ×•×™ ×”×•×¤×¢×œ!");
  };

  onAuthStateChanged(auth, (user) => {
    if(user) {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('store-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        onSnapshot(doc(db, "users", user.uid), (d) => {
            const data = d.data();
            document.getElementById('user-display').innerText = data.fullName || data.email;
            document.getElementById('user-balance-nav').innerText = data.balance.toLocaleString() + " â‚ª";
            if(data.hasDiscordSub) {
                document.getElementById('discord-status-not-member').classList.add('hidden');
                document.getElementById('discord-status-member').classList.remove('hidden');
            }
            if(data.role === 'admin') {
                document.getElementById('admin-section').classList.remove('hidden');
                loadAdminTable();
            }
        });
        onSnapshot(query(collection(db, "userCodes"), where("uid", "==", user.uid)), (snap) => {
            const l = document.getElementById('user-codes-list'); l.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data();
                l.innerHTML += `<li class="card" style="margin-bottom:10px; padding:15px; border-right:4px solid var(--primary); display:flex; justify-content:space-between;">
                    <div>
                        <div style="font-weight:bold;">ğŸ« ${data.teams}</div>
                        <div style="font-size:0.85rem; color:gray;">×©×¢×”: ${data.time || '×œ× ×¦×•×™×Ÿ'}</div>
                    </div>
                    <span style="font-family:monospace; color:var(--primary); font-weight:bold; align-self:center;">${data.code}</span>
                </li>`;
            });
        });
    } else {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('store-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('user-info').classList.add('hidden');
    }
  });

  async function loadAdminTable() {
    const snap = await getDocs(collection(db, "users"));
    const list = document.getElementById('admin-users-list'); list.innerHTML = "";
    snap.forEach(d => {
        const u = d.data();
        
        let emailDisplay = u.email;
        if(u.role === 'admin') {
            emailDisplay = '<span style="color:#777;">****** (×—×¡×•×™ - ×× ×”×œ)</span>';
        }

        list.innerHTML += `<tr>
            <td>${u.fullName || '×œ×œ× ×©×'}</td>
            <td>${emailDisplay}</td>
            <td>${u.balance.toLocaleString()} â‚ª</td>
            <td>${u.hasDiscordSub ? 'âœ…' : '-'}</td>
            <td>
                <input type="number" id="input-money-${d.id}" placeholder="â‚ª" style="width:50px; margin:0; padding:5px;">
                <button onclick="addCustomMoney('${d.id}')" style="background:var(--admin-color); border:none; padding:5px; cursor:pointer;">+</button>
            </td>
        </tr>`;
    });
  }

  window.addCustomMoney = async (uid) => {
    const val = document.getElementById(`input-money-${uid}`).value;
    const ref = doc(db, "users", uid);
    const s = await getDoc(ref);
    await updateDoc(ref, { balance: (s.data().balance || 0) + Number(val) });
    showToast("×”×™×ª×¨×” ×¢×•×“×›× ×”");
    loadAdminTable();
  };

  document.getElementById('admin-close-game').onclick = async () => {
    await updateDoc(doc(db, "settings", "gameConfig"), { isOpen: false });
    showToast("×”××›×™×¨×” × ×¡×’×¨×”");
  };
</script>
</body>
</html>
