<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¢×¨×›×ª ×›×¨×˜×™×¡×™×</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #00f2ea; --secondary: #ff0055; --admin-color: #ff9800; --discord-color: #5865F2;
    --bg-dark: #0a0a12; --surface: rgba(255, 255, 255, 0.05); --text-main: #ffffff;
  }
  * { box-sizing: border-box; outline: none; }
  body { font-family: 'Heebo', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; direction: rtl; }
  
  nav { display: flex; justify-content: space-between; padding: 15px 40px; background: rgba(10, 10, 18, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
  .logo { font-size: 24px; font-weight: 900; color: var(--primary); }

  main { max-width: 1100px; margin: 40px auto; width: 90%; display: grid; gap: 20px; }
  .card { background: var(--surface); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
  .hidden { display: none !important; }

  input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; margin-bottom: 10px; }
  .action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; background: linear-gradient(45deg, var(--secondary), #ff4d88); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
  .action-btn:hover { opacity: 0.9; transform: scale(1.02); }
  
  .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
  .admin-table th, .admin-table td { padding: 10px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1); }
  
  .game-box { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 20px; border-radius: 15px; text-align: center; border: 2px solid var(--primary); }
  .toast { position: fixed; bottom: 20px; left: 20px; background: #1a1a2e; color: #fff; padding: 15px; border-radius: 10px; border-right: 4px solid var(--primary); z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<nav>
  <div class="logo">ShopIL</div>
  <div id="user-info" class="hidden" style="display:flex; align-items:center; gap:15px;">
    <div style="text-align: left;"><span id="user-display" style="font-weight:900"></span><br><small id="user-balance-nav" style="color:var(--primary)">0 â‚ª</small></div>
    <button id="logoutBtn" style="background:none; border:1px solid var(--primary); color:var(--primary); cursor:pointer; border-radius:20px; padding:5px 15px;">×”×ª× ×ª×§</button>
  </div>
</nav>

<main>
  <section id="auth-section" class="card">
    <h2 id="auth-title">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
    <div id="signup-fields" class="hidden">
        <input type="text" id="reg-name" placeholder="×©× ××œ×">
    </div>
    <input type="email" id="email" placeholder="××™××™×™×œ">
    <input type="password" id="password" placeholder="×¡×™×¡××” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)">
    
    <button id="authActionBtn" class="action-btn">×”×ª×—×‘×¨</button>
    
    <p style="text-align:center; margin-top:15px;">
        <span id="toggleText">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?</span>
        <button id="toggleRegBtn" style="background:none; border:none; color:var(--primary); cursor:pointer; text-decoration:underline;">×”×™×¨×©× ×›××Ÿ</button>
    </p>
  </section>

  <section id="store-section" class="card hidden">
    <h2>×”××©×—×§ ×”×§×¨×•×‘</h2>
    <div id="no-game" style="text-align:center; opacity:0.6;">××™×Ÿ ××©×—×§ ×¤×¢×™×œ ×›×¨×’×¢. ×”××ª×Ÿ ×œ×× ×”×œ.</div>
    
    <div id="active-game-box" class="game-box hidden">
        <h1 id="display-teams" style="margin:10px 0; color:var(--primary);">...</h1>
        <p>××—×™×¨ ×›× ×™×¡×”: <span id="display-price" style="font-weight:bold;">0</span> â‚ª</p>
        <button id="buyGameBtn" class="action-btn">×¨×›×•×© ×›×¨×˜×™×¡ ×•×§×‘×œ ×§×•×“</button>
    </div>
  </section>

  <section id="dashboard-section" class="card hidden">
    <h2>×”×›×¨×˜×™×¡×™× ×©×œ×™</h2>
    <div id="loading-codes">×˜×•×¢×Ÿ ×›×¨×˜×™×¡×™×...</div>
    <ul id="user-codes-list" style="list-style:none; padding:0;"></ul>
  </section>

  <section id="admin-section" class="card hidden" style="border-color:var(--admin-color); grid-column: 1 / -1;">
    <h2 style="color:var(--admin-color);">ğŸ›  ×¤×× ×œ ×× ×”×œ</h2>
    
    <div style="background:rgba(255,152,0,0.1); padding:15px; border-radius:10px; margin-bottom:20px;">
        <h4>×”×’×“×¨×ª ××©×—×§ ×—×“×©</h4>
        <input type="text" id="admin-teams" placeholder="×©× ×”××©×—×§ (×œ×“×•×’××”: ×—×™×¤×” × ×’×“ ×ª×œ ××‘×™×‘)">
        <input type="number" id="admin-price" placeholder="××—×™×¨ ×›×¨×˜×™×¡ (â‚ª)">
        <input type="text" id="admin-game-code" placeholder="×”×§×•×“/×§×™×©×•×¨ ×©×”×œ×§×•×— ×™×§×‘×œ">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="admin-open-game" class="action-btn" style="background:#4caf50;">×¤×ª×— ×œ××›×™×¨×”</button>
            <button id="admin-close-game" class="action-btn" style="background:var(--secondary);">×¡×’×•×¨ ××©×—×§</button>
        </div>
    </div>

    <h4>××©×ª××©×™× ×¨×©×•××™×</h4>
    <table class="admin-table">
        <thead><tr><th>×©×</th><th>××™××™×™×œ</th><th>×™×ª×¨×”</th><th>×”×•×¡×¤×ª ×›×¡×£</th></tr></thead>
        <tbody id="admin-users-list"></tbody>
    </table>
  </section>
</main>

<script type="module">
  // ×™×™×‘×•× Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // --- ×”×’×“×¨×•×ª Firebase ×©×œ×š ---
  // ×•×•×“× ×©×”×”×’×“×¨×•×ª ×”××œ×” ×ª×•×××•×ª ×œ×¤×¨×•×™×§×˜ ×©×œ×š
  const firebaseConfig = {
    apiKey: "AIzaSyDo06TWeTpDCiHjE6gu5yCx9MalJ3Pfpz0", // ×©×™× ×œ×‘! ×× ×–×” ×œ× ×¢×•×‘×“, ×¢×œ×™×š ×œ×”×—×œ×™×£ ×œ-API KEY ×××™×ª×™ ××”×¤×¨×•×™×§×˜ ×©×œ×š
    authDomain: "habigon-b3544.firebaseapp.com",
    projectId: "habigon-b3544",
    storageBucket: "habigon-b3544.firebasestorage.app",
    messagingSenderId: "1006576861174",
    appId: "1:1006576861174:web:41d2fd9a7a72651b3cd1d7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ××©×ª× ×™ ××¢×¨×›×ª
  let isLoginMode = true;
  let currentUserData = null;

  // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×•×“×¢×•×ª
  function showToast(msg) {
    const t = document.createElement('div'); 
    t.className = 'toast'; 
    t.innerText = msg;
    document.body.appendChild(t); 
    setTimeout(() => t.remove(), 4000);
  }

  // --- ×œ×•×’×™×§×” ×©×œ ×”×ª×—×‘×¨×•×ª ×•×”×¨×©××” ---
  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const nameInput = document.getElementById('reg-name');
  const authBtn = document.getElementById('authActionBtn');

  // ××¢×‘×¨ ×‘×™×Ÿ ×”×ª×—×‘×¨×•×ª ×œ×”×¨×©××”
  document.getElementById('toggleRegBtn').onclick = () => {
    isLoginMode = !isLoginMode;
    document.getElementById('signup-fields').classList.toggle('hidden', isLoginMode);
    document.getElementById('auth-title').innerText = isLoginMode ? "×›× ×™×¡×” ×œ××¢×¨×›×ª" : "×”×¨×©××” ×œ××¢×¨×›×ª";
    authBtn.innerText = isLoginMode ? "×”×ª×—×‘×¨" : "×¦×•×¨ ×—×©×‘×•×Ÿ";
    document.getElementById('toggleText').innerText = isLoginMode ? "××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ?" : "×›×‘×¨ ×¨×©×•×?";
    document.getElementById('toggleRegBtn').innerText = isLoginMode ? "×”×™×¨×©× ×›××Ÿ" : "×”×ª×—×‘×¨";
  };

  // ×‘×™×¦×•×¢ ×”×¤×¢×•×œ×” (×”×ª×—×‘×¨×•×ª ××• ×”×¨×©××”)
  authBtn.onclick = async () => {
    const email = emailInput.value;
    const password = passInput.value;

    if(!email || !password) return showToast("×× × ××œ× ××™××™×™×œ ×•×¡×™×¡××”");

    try {
        if (isLoginMode) {
            // ×”×ª×—×‘×¨×•×ª
            await signInWithEmailAndPassword(auth, email, password);
            showToast("×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!");
        } else {
            // ×”×¨×©××”
            if(!nameInput.value) return showToast("×—×•×‘×” ×œ××œ× ×©× ××œ×");
            const res = await createUserWithEmailAndPassword(auth, email, password);
            
            // ×™×¦×™×¨×ª ××©×ª××© ×‘×“××˜×”×‘×™×™×¡
            await setDoc(doc(db, "users", res.user.uid), {
                fullName: nameInput.value,
                email: email,
                balance: 0,
                role: 'user', // ×‘×¨×™×¨×ª ××—×“×œ: ××©×ª××© ×¨×’×™×œ
                createdAt: new Date()
            });
            showToast("×—×©×‘×•×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!");
        }
    } catch (error) {
        console.error(error);
        let msg = "×©×’×™××”: " + error.code;
        if(error.code === 'auth/email-already-in-use') msg = "×”××™××™×™×œ ×”×–×” ×›×‘×¨ ×¨×©×•× ×‘××¢×¨×›×ª";
        if(error.code === 'auth/weak-password') msg = "×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×";
        if(error.code === 'auth/wrong-password') msg = "×¡×™×¡××” ×©×’×•×™×”";
        if(error.code === 'auth/user-not-found') msg = "××©×ª××© ×œ× × ××¦×";
        showToast(msg);
    }
  };

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // --- × ×™×”×•×œ ××¦×‘ ××©×ª××© (×××–×™×Ÿ ×œ×©×™× ×•×™×™×) ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        // ××©×ª××© ××—×•×‘×¨
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('store-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        
        // ×”××–× ×” ×œ×©×™× ×•×™×™× ×‘×¤×¨×˜×™ ×”××©×ª××© (×™×ª×¨×” ×•×›×•')
        onSnapshot(doc(db, "users", user.uid), (docSnap) => {
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                document.getElementById('user-display').innerText = currentUserData.fullName;
                document.getElementById('user-balance-nav').innerText = currentUserData.balance + " â‚ª";
                
                // ×‘×“×™×§×ª ××“××™×Ÿ
                if (currentUserData.role === 'admin') {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdminUsers();
                } else {
                    document.getElementById('admin-section').classList.add('hidden');
                }
            }
        });

        loadUserTickets(user.uid);

    } else {
        // ××©×ª××© ×× ×•×ª×§
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('store-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('admin-section').classList.add('hidden');
        currentUserData = null;
    }
  });

  // --- ×—× ×•×ª ×•××©×—×§×™× ---
  
  // ×”××–× ×” ×œ×”×’×“×¨×•×ª ×”××©×—×§ ×‘×–××Ÿ ×××ª
  onSnapshot(doc(db, "settings", "gameConfig"), (snap) => {
    if(snap.exists()){
        const d = snap.data();
        if(d.isOpen) {
            document.getElementById('no-game').classList.add('hidden');
            document.getElementById('active-game-box').classList.remove('hidden');
            
            document.getElementById('display-teams').innerText = d.teams;
            document.getElementById('display-price').innerText = d.price;
            
            // ×©××™×¨×ª × ×ª×•× ×™× ×’×œ×•×‘×œ×™×™× ×œ×©×™××•×© ×‘×¨×›×™×©×”
            window.currentGamePrice = d.price;
            window.currentGameTeams = d.teams;
            window.currentGameCode = d.gameCode;
        } else {
            document.getElementById('no-game').classList.remove('hidden');
            document.getElementById('active-game-box').classList.add('hidden');
        }
    }
  });

  // ×¨×›×™×©×ª ×›×¨×˜×™×¡
  document.getElementById('buyGameBtn').onclick = async () => {
    if(!currentUserData) return;
    
    if(currentUserData.balance < window.currentGamePrice) {
        return showToast("âŒ ××™×Ÿ ×œ×š ××¡×¤×™×§ ×›×¡×£ ×‘×—×©×‘×•×Ÿ!");
    }

    try {
        // 1. ×”×•×¨×“×ª ×›×¡×£
        await updateDoc(doc(db, "users", auth.currentUser.uid), { 
            balance: currentUserData.balance - window.currentGamePrice 
        });

        // 2. ×”×•×¡×¤×ª ×”×›×¨×˜×™×¡ ×¢× ×”×§×•×“ ×©×”×•×’×“×¨
        await addDoc(collection(db, "userCodes"), { 
            uid: auth.currentUser.uid, 
            code: window.currentGameCode, // ×”×§×•×“ ××”××“××™×Ÿ
            teams: window.currentGameTeams,
            purchasedAt: new Date()
        });

        showToast("âœ… ×”×›×¨×˜×™×¡ × ×¨×›×© ×‘×”×¦×œ×—×”! ×‘×“×•×§ ×œ××˜×”.");
    } catch (e) {
        showToast("×©×’×™××” ×‘×¨×›×™×©×”: " + e.message);
    }
  };

  // ×˜×¢×™× ×ª ×”×›×¨×˜×™×¡×™× ×©×œ ×”××©×ª××©
  function loadUserTickets(uid) {
    const q = query(collection(db, "userCodes"), where("uid", "==", uid));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('user-codes-list');
        document.getElementById('loading-codes').classList.add('hidden');
        list.innerHTML = "";
        
        if(snapshot.empty) {
            list.innerHTML = "<li style='opacity:0.5'>×¢×“×™×™×Ÿ ×œ× ×¨×›×©×ª ×›×¨×˜×™×¡×™×</li>";
        }

        snapshot.forEach(docItem => {
            const data = docItem.data();
            list.innerHTML += `
            <li class="card" style="margin-bottom:15px; padding:15px; border-right:4px solid var(--primary); display:flex; flex-direction:column; gap:10px;">
                <div style="font-size:1.2em; font-weight:bold; color:var(--primary);">${data.teams}</div>
                <div style="background:rgba(0,0,0,0.4); padding:10px; border-radius:8px; font-family:monospace; display:flex; justify-content:space-between; align-items:center;">
                    <span>×§×•×“: <strong style="color:#fff; user-select:all;">${data.code}</strong></span>
                    <i class="fa fa-copy" style="cursor:pointer; opacity:0.7;" onclick="navigator.clipboard.writeText('${data.code}')"></i>
                </div>
            </li>`;
        });
    });
  }

  // --- ×œ×•×’×™×§×” ×©×œ ××“××™×Ÿ ---

  // ×¤×ª×™×—×ª ××©×—×§
  document.getElementById('admin-open-game').onclick = async () => {
    const teams = document.getElementById('admin-teams').value;
    const price = document.getElementById('admin-price').value;
    const code = document.getElementById('admin-game-code').value;

    if(!teams || !price || !code) return showToast("×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×•×œ×œ ×§×•×“!");

    await setDoc(doc(db, "settings", "gameConfig"), { 
        isOpen: true, 
        teams: teams, 
        price: Number(price), 
        gameCode: code 
    });
    showToast("×”××©×—×§ × ×¤×ª×—!");
  };

  // ×¡×’×™×¨×ª ××©×—×§
  document.getElementById('admin-close-game').onclick = async () => {
    await updateDoc(doc(db, "settings", "gameConfig"), { isOpen: false });
    showToast("×”××©×—×§ × ×¡×’×¨.");
  };

  // ×˜×¢×™× ×ª ××©×ª××©×™× ×œ×˜×‘×œ×”
  async function loadAdminUsers() {
    const snap = await getDocs(collection(db, "users"));
    const list = document.getElementById('admin-users-list'); 
    list.innerHTML = "";
    
    snap.forEach(d => {
        const u = d.data();
        list.innerHTML += `
        <tr>
            <td>${u.fullName}</td>
            <td>${u.email}</td>
            <td dir="ltr">${u.balance} â‚ª</td>
            <td>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="money-input-${d.id}" placeholder="×›××•×ª" style="width:60px; padding:5px; font-size:12px; margin:0;">
                    <button onclick="window.addMoney('${d.id}')" style="background:#4caf50; border:none; color:white; border-radius:5px; cursor:pointer;">+</button>
                </div>
            </td>
        </tr>`;
    });
  }

  // ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª ×œ×”×•×¡×¤×ª ×›×¡×£ (×›×“×™ ×©×ª×¢×‘×•×“ ××ª×•×š ×”-HTML)
  window.addMoney = async (userId) => {
    const amountInput = document.getElementById(`money-input-${userId}`);
    const amount = Number(amountInput.value);
    
    if(!amount) return showToast("×”×›× ×¡ ×¡×›×•×");

    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);
    const currentBal = userSnap.data().balance || 0;

    await updateDoc(userRef, { balance: currentBal + amount });
    showToast("×”×™×ª×¨×” ×¢×•×“×›× ×”!");
    
    // × ×™×§×•×™ ×©×“×” ×•×¨×¢× ×•×Ÿ ×˜×‘×œ×”
    amountInput.value = "";
    loadAdminUsers(); 
  };

</script>
</body>
</html>
